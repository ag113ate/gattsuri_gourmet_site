<script>
  $(function(){
    /* サイドバーについて、幅を設定                              */
    /* ※ サイドバーは固定表示しているためJQueryにより幅を設定   */
    $('#user_info').css('width', $('side_bar').width());
    $('#user_id_disp').css('width', $('#side_bar').width());
    
    
    /* ====================================================================== */
    /*          オーバーレイ、モーダルウインドウを表示                        */
    /* ================================ start =============================== */
    function disp_overlay_modal(_this){
      /* 表示領域の調整 */
      (function(){
        if ($('#modal_window').width() < 500){
          $('#modal_window').css('width', '500');
        }
    
        if ($('#modal_window').height() < 200){
          $('#modal_window').css('height', '200');
        }
      })();
      
      /* 表示位置の設定　*/
      (function(_this){
        /* ページの真中に表示されるよう、左、上位置を設定 */
        var left = ($(window).width()  - $('#modal_window').width() ) / 2;
        var top  = ($(window).height() - $('#modal_window').height()) / 2;
      
        /* トップ、レフトの位置とも0以上とする                               */
        /* （モーダルウィンドウのサイズ > 表示サイズ）となっている場合の対策 */
        left = (left >= 0) ? (left) : (0);
        top = (top >= 0) ? (top) : (0);
        
        $('#modal_window').css('left', left);
        $('#modal_window').css('top', top);
      })();

      /* 対象店舗の表示位置を取得　*/
      var index = $('.bookmark-area').index(_this);
      
      /* 店舗名の表示 */
      $store_name_area = $("[id^='store_area_']").eq(index).find('.store-name-area');
      $('#modal_window_store_title span').text($store_name_area.text());
      
      /* ----------------------------------------------------- */
      /*        「削除」ボタンのリンク先を作成                 */
      /* ------------------- start---------------------------- */
      
      /* 店舗IDを取得                                          */
      /* 例： str = split('store_area_gec0501')                */
      /*      str[0] => store, str[1] => area,                 */
      /*      str[2] => gec0501                                */
      split_str = $("[id^='store_area_']").eq(index).attr('id').split('_');
      
      /* リンクの設定 */
      link_str = "/gourmet_sites/bookmark/" + split_str[2];
      $('#bookmark_delete_btn').attr('href', link_str);
      /* -------------------- end ---------------------------- */
      
      /* オーバーレイ、モーダルウィンドウを表示 */
      $('#overlay').css('display', 'block');
      $('#modal_window').css('display', 'block');
    }
    /* ====================================================================== */
    /*             オーバーレイ、モーダルウインドウを表示                     */
    /* ============================== end =================================== */
    
    
    /* ====================================================================== */
    /*     「キャンセル」、「削除」ボタンをクリックした時の動作               */
    /* ============================= start ================================== */
    $('#modal_window_close_btn, #bookmark_delete_btn').on('click', function(){
      /* モーダルウィンドウ、オーバーレイ表示を閉じる */
      $('#overlay, #modal_window').css('display', 'none');
      

      /* 表示位置の設定                                            */
      /* ※  固定表示していたモーダルウィンドウを閉じた際に        */
      /*    ページの上部にスクロールされるため                     */
      /*    scrollTop関数が効かないため、animate関数を利用         */      
      var position = $(window).scrollTop();
      $("body,html").animate({scrollTop:position}, 1, "linear");
    });
    /* ============================== end =================================== */
    
    
    /* ====================================================================== */
    /*         「お気に入り削除」ボタンをクリックした時の動作                 */
    /* ============================= start ================================== */
    $('.bookmark-area').on('click', function(){
      /* オーバーレイ、モーダル表示 */
      disp_overlay_modal(this);
      
      /* 表示位置の設定                                            */
      /* ※ モーダルウィンドウを固定表示しているため、そのままでは */
      /*    ページの上部にスクロールされるため                     */
      /*    scrollTop関数が効かないため、animate関数を利用         */
      var position = $(window).scrollTop();
      $("body,html").animate({scrollTop:position}, 1, "linear");
    });
    /* ============================== end =================================== */
  });
  
  function getPosition($selector){
    offset_top = $selector.offset().top +  $selector.outerHeight();
    
    pos_left = $selector.offset().left;
    pos_top = $('#header').height();
    
    width = $selector.width();
    
    margin = $selector.css('margin');
    
    var obj = {
      offset_top: offset_top,
      
      pos_left: pos_left,
      pos_top: pos_top,
      
      width: width,
      
      margin: margin}
      
    return obj;
  }
  
  function setFixedDisp($selector, obj){
    console.log("abcedfg");
    $selector.css('position', 'fixed');
    $selector.css('width', obj.width);
    $selector.css('left', obj.pos_left);
    $selector.css('top', obj.pos_top);
    $selector.css('margin', '0 0 0 0');
    $selector.css('z-index', 20);
    
    $selector.css('-webkit-border-radius','0px');
    $selector.css('-moz-border-radius', '0px');
    $selector.css('border-radius', '0px');
  }
  
  function unsetFixedDisp($selector, obj){
    console.log('b');
    $selector.css('position', '');
    $selector.css('width', '');
    $selector.css('left', '');
    $selector.css('top', '');
    $selector.css('margin', obj.margin);
    $selector.css('z-index', '');
    
    $selector.css('-webkit-border-radius','10px');
    $selector.css('-moz-border-radius', '10px');
    $selector.css('border-radius', '10px');
  }
  
  $(window).on('load', function(){
    /* 「お気に入り店舗一覧」タイトルについて     */
    var $bookmark_title = $('#bookmark_title');
    console.log("*********************");
    var bookmark_title_obj = getPosition($bookmark_title);
    
    /* 「投稿口コミ一覧」タイトルについて */
    $show_review_title = $('#show_review_title');
    show_review_title_obj = getPosition($show_review_title);
    
    
    $(window).scroll(function(){
      window_top = ($(window).scrollTop());
      // 「お気に入り店舗一覧」タイトルについて
      if (((window_top + bookmark_title_obj.pos_top) > bookmark_title_obj.offset_top) &&
           (window_top < (show_review_title_obj.offset_top - 300))){
        setFixedDisp($bookmark_title, bookmark_title_obj);
      }
      else{
        unsetFixedDisp($bookmark_title, bookmark_title_obj);
      }
      
      // 「投稿口コミ一覧」タイトルについて
      if ((window_top + show_review_title_obj.pos_top) > show_review_title_obj.offset_top){
        setFixedDisp($show_review_title, show_review_title_obj);
      }
      else{
        unsetFixedDisp($show_review_title, show_review_title_obj);
      }
    });
    
  });
</script>

<div id="modal_window">
  <div id="modal_window_store_title"><span></span></div>
  <div id="modal_window_select_area">
    この店舗をお気に入りから削除しますか？<br>
    <ul>
      <li><%= link_to "削除", "#", method: :delete, remote: true,
                                   id: "bookmark_delete_btn", class:"btn blue_font" %></li>
      <li><%= link_to("キャンセル", "#", id: "modal_window_close_btn", class: "btn") %></li>
    </ul>
  </div>
  
</div>
  
<div id="mypage_title">
  マイページ
</div>
<div id="main_panel">
  <div id="bookmark_area">
    <div id="bookmark_title">
      お気に入り店舗一覧
    </div> <!-- bookmark_title -->
    <%  @user.bookmark_stores.each do |bookmark_store|                                      %>
    <%=   render partial: "layouts/store_info_disp", locals: {store: bookmark_store.store}  %>
    <%  end                                                                                 %>
  </div> <!-- bookmark_area -->
  
  <div id="show_review_area">
    <div id="show_review_title">
      投稿口コミ一覧
    </div>

<%  @user.reviews.each do |review|                                            %>
      <div id="show_review_vote_<%= review.vote_id %>">
        <div class="show-review-store-title" class="clearfix">
<%=      review.store.name                                                      %>
        </div> <!-- "show-review-store-title" -->
        
        <div class="show-review-menu-name">
          <%= review.menu_name %>
        </div> <!-- show-review-menu-name -->
        
        <div class="show-review-score">
              <ul>
<%              for loop in 1..5 do                                           %>
                  <li>
<%                  if (loop <= review.total_score)                           %>
<%=                   image_tag("meat_color_all.png", class: "review-icon")   %>
<%                  elsif ((loop - 0.5) <= review.total_score)                %>
<%=                   image_tag("meat_color_half.png", class: "review-icon")  %>
<%                  else                                                      %>
<%=                   image_tag("meat_color_none.png", class: "review-icon")  %>
<%                  end                                                       %>
                  </li>
<%              end                                                           %>
                 
              
              <li class="show-review-point"><%= review.total_score %></li>
              </ul> 
            </div> <!-- show-review-score -->

        <div class="show-review-content clearfix">
          <div class="show-review-content-left-side clearfix">
<%          if (review.food_image != nil)                                     %>
              <div class="show-review-image">
<%=             image_tag("store_img/#{review.food_image.image_url}",
                                                class: "img-param")           %>                
              </div>
<%          end                                                               %>
          </div> <!-- show-review-content-left-side -->
          
          <div class="show-review-right-side">
            <div class="show-review-comment">
<%=           review.comment                                                  %>
            </div> <!-- show-review-comment -->
            <br><br>
            <div class="show-review-date">
<%=           review.updated_at.strftime("%Y年%m月%d日")                      %>
            </div> <!-- show-review-date -->
          </div> <!-- show-review-right-side -->
        </div> <!-- show-review-content -->
        
        <div class="show-review-footer">
          <ul>
            <li><%= link_to("口コミを編集",
                       "/reviews/#{review.store_id}/#{review.vote_id}/edit",
                       class: "btn") %></li>
            <li><%= link_to("口コミを削除", "#",  class: "btn") %></li>
            <li class="target_store_all_review"><%= link_to("この店舗の口コミをすべて見る", 
              "/reviews/#{review.store.store_id}", class: "btn", target: "blank") %></li>
          </ul>
        </div>
      </div> <!-- review_XX -->
<%  end                                                                       %>

  </div> <!-- show_review_area -->
</div> <!-- main_panel -->

<div id="side_bar">
  <div id="user_info">
    <div id="user_id_disp">
      <%= @user.user_id %> さん
    </div>
    
    <div class="user_info_element">
      <div class="user_info_element_title">
        お気に入り店舗
      </div>
      <%# store_area %>
      <%= link_to("お気に入り店舗", {anchor: "store_area^="}) %>
      <div id="bookmark_count_disp", class="user_info_element_count">
        <%= @user.bookmark_stores.count %> 店舗
      </div>
    </div>
    
    <div class="user_info_element">
      <div class="user_info_element_title">
        口コミ数
      </div>
      <div class="user_info_element_count">
        <%= @user.reviews.count %> 件
      </div>
    </div>
    
    <div id="user_info_navi">
      <ul>
        <li><%= link_to("ログアウト", "/users/logout", method: "post") %></li>
        <li><%= link_to("パスワード変更", "#", method: "post") %></li>
        <li><%= link_to("アカウント削除", "#", method: "post") %></li>
      </ul>
    </div>
  </div>
</div>

